---
# Feature Specification (YAML Format)
# Reference: Anthropic context engineering - "smallest set of high-signal tokens"
# Optimized for Claude Code context efficiency and resumability

# === STRUCTURE (Progressive Disclosure) ===
# Reference: Skills best practices - three-level context loading
# 1. CRITICAL (always read): metadata, overview, current requirements
# 2. DETAILED (read when implementing): technical_design, testing, components
# 3. REFERENCE (read on-demand): architecture.md, roadmap.yml, guidelines.md
#
# WHY: Claude 4.5 features context awareness - this structure helps manage token budget
# efficiently while ensuring critical information is always available

# === CRITICAL CONTEXT (Read First) ===

metadata:
  feature_name: "{{FEATURE_NAME}}"
  created: "{{CREATED_DATE}}"
  last_updated: null  # Track iterations for context awareness
  status: "planning"  # planning | in_progress | testing | complete
  priority: "medium"  # high | medium | low

  # Context Management - Reference: Claude 4.5 context awareness
  # WHY: Help Claude manage token budget and choose appropriate thinking modes
  token_budget_tier: "standard"  # standard | extended | minimal
  complexity: "medium"           # simple | medium | complex (affects extended thinking usage)

  # Architecture Reference - Progressive disclosure
  architecture_doc: "architecture.md"  # Detailed design and ADRs
  context_doc: "context.md"           # Session resumption context

  # Multi-Agent Mode (optional)
  agent_coordination: false  # Set to true to enable domain-expert agents
  domains: []  # List domains this feature touches: backend, frontend, devops, database, infrastructure

  # MCP Integration (optional - enhanced multi-agent mode)
  mcp_integration:
    enabled: false  # Set to true to use MCP-based domain experts (requires installation)
    fallback_to_prompt: true  # Fall back to prompt-based agents if MCP not available
    servers:  # MCP server packages for each domain
      backend: "@claude-spec/backend-mcp-server"
      frontend: "@claude-spec/frontend-mcp-server"
      devops: "@claude-spec/devops-mcp-server"
      database: "@claude-spec/database-mcp-server"
      infrastructure: "@claude-spec/infrastructure-mcp-server"

overview:
  description: |
    Brief 2-3 sentence description of what this feature does and why it's needed.

  user_problem: |
    Describe the problem from the user's perspective.

  user_stories:
    - role: "user type"
      action: "what they want to do"
      benefit: "why they want it"

requirements:
  functional:
    - id: "FR1"
      description: "Requirement description"
      acceptance_criteria:
        - "Criterion 1"
        - "Criterion 2"
      completed: false

    - id: "FR2"
      description: "Another requirement"
      acceptance_criteria:
        - "Criterion 1"
      completed: false

  non_functional:
    performance:
      - metric: "Response time"
        target: "< 200ms"

    security:
      # See CLAUDE.md "Security - OWASP Top 10 (CRITICAL)" for full guidance
      owasp_applicable:
        - id: "A01"
          category: "Access Control"
          mitigation: "Authorization checks on all endpoints"
        - id: "A02"
          category: "Cryptography"
          mitigation: "Password hashing with bcrypt/Argon2"
        - id: "A03"
          category: "Injection"
          mitigation: "Parameterized queries, input validation"
      reference: "CLAUDE.md Section: Security - OWASP Top 10"

    accessibility:
      - "WCAG 2.1 AA compliant"
      - "Keyboard navigation"

    browser_support:
      - "Chrome (latest 2 versions)"
      - "Firefox (latest 2 versions)"
      - "Safari (latest 2 versions)"

technical_design:
  # Reference to detailed architecture document
  architecture_reference: "See architecture.md for detailed design and ADRs"

  # Architecture Decision Records (ADRs) - Summaries from architecture.md
  architecture_decisions:
    - "ADR-001: [Key decision summary]"
    - "ADR-002: [Key decision summary]"

  # Standard structure (use this for single-domain features)
  architecture:
    approach: "High-level technical approach"
    affected_systems:
      - "Component 1"
      - "Component 2"

  components:
    created:
      - name: "ComponentName"
        type: "service | controller | model | view | utility"
        purpose: "What it does"
        location: "path/to/component"

    modified:
      - name: "ExistingComponent"
        changes: "What will be changed"
        location: "path/to/component"

  data_models:
    - name: "ModelName"
      schema: |
        {
          id: uuid,
          field1: string,
          field2: number
        }

  api_endpoints:
    - method: "POST"
      path: "/api/endpoint"
      description: "What it does"
      request: "Request format"
      response: "Response format"

  dependencies:
    external:
      - name: "package-name"
        version: "^1.0.0"
        purpose: "What it's used for"

    internal:
      - "Existing module/service"

  # Multi-Agent Mode: Domain-Specific Design (optional - use when agent_coordination: true)
  domain_design:
    backend:
      architecture:
        approach: "Backend-specific technical approach"
      components:
        created: []
        modified: []
      api_endpoints: []
      data_models: []
      dependencies:
        external: []
        internal: []

    frontend:
      architecture:
        approach: "Frontend-specific technical approach"
      components:
        created: []
        modified: []
      ui_components: []
      state_management: "Describe state management approach"
      dependencies:
        external: []
        internal: []

    devops:
      architecture:
        approach: "DevOps/Infrastructure approach"
      infrastructure:
        - "Infrastructure component or config"
      secrets:
        - "Secret/config to add"
      deployment:
        - "Deployment step or config"
      dependencies:
        external: []

    database:
      migrations: []
      schema_changes: []
      indexes: []

    infrastructure:
      resources: []
      configurations: []

  logging:
    # Reference: Claude 4 best practices - "explicit instructions with contextual motivation"
    # WHY logging: Critical for debugging and context persistence across sessions
    # WHY these specific points: Enables Claude to understand execution flow when resuming

    debug_enabled: true  # Enable during development (see CLAUDE.md)

    key_log_points:
      # Entry/exit points - WHY: Understand control flow and function boundaries
      - "Entry points (API handlers, function entry with parameters)"
      - "Exit points (return values, function completion)"

      # Error tracking - WHY: Critical for debugging and reproducing issues
      - "Error cases and exceptions (with stack traces)"
      - "Validation failures (with input that failed validation)"

      # State tracking - WHY: Understand application behavior and state transitions
      - "State changes and decisions (before/after values)"
      - "External API calls (request/response/timing)"
      - "Database operations (queries, mutations, affected rows)"

    # WHY INFO level: Balances observability with performance in production
    production_log_level: "INFO"  # ERROR < WARN < INFO < DEBUG

    log_context:
      # Correlation - WHY: Trace requests across distributed services
      - "Request IDs (for distributed tracing)"
      - "User IDs (for user-specific debugging)"
      - "Session IDs (for session flow analysis)"
      - "Key parameters (for input validation and replay)"

ui_ux:
  design_notes: |
    User interface requirements, user flows, or reference to mockups.

  mockups_url: "https://figma.com/..."  # If applicable

testing:
  # Reference: Claude Code Best Practices - Test-Driven Development approach
  # WHY: TDD ensures code meets specifications and prevents overfitting to examples

  strategy:
    approach: "tdd"  # tdd | minimal | balanced

    # TDD Workflow (Reference: Anthropic Claude Code Best Practices)
    # 1. Write tests from expected input/output pairs
    # 2. Confirm tests fail initially (red phase)
    # 3. Commit test suite
    # 4. Develop code to pass tests through iteration (green phase)
    # 5. Use independent subagent to verify against overfitting (refactor phase)

    workflow_checkpoints:
      - "Tests written and committed (red phase - tests should fail)"
      - "Implementation makes tests pass (green phase)"
      - "Code refactored for quality (refactor phase)"
      - "Independent verification completed (no overfitting to test cases)"

    unit_tests:
      - "Component/function to test"

    integration_tests:
      - "Workflow to test"

    e2e_tests:
      - "Critical path to test"

    manual_tests:
      - "Edge case to verify manually"

  test_credentials:
    # See CLAUDE.md "Test Credentials & Data (CRITICAL)" for full guidance
    reference: "CLAUDE.md Section: Test Credentials & Data"

    test_users:
      - role: "admin"
        email: "admin@test.example.com"
        password_env: "TEST_ADMIN_PASSWORD"  # In .env.test, randomly generated 14+ chars
        purpose: "Testing admin-only features"

      - role: "user"
        email: "user@test.example.com"
        password_env: "TEST_USER_PASSWORD"  # In .env.test, randomly generated 14+ chars
        purpose: "Testing standard user workflows"

    test_database:
      name: "{{APP_NAME}}_test"
      username_env: "TEST_DB_USER"
      password_env: "TEST_DB_PASSWORD"

    environment:
      file: ".env.test"  # Gitignored, contains actual random credentials
      template: ".env.example"  # Committed, contains placeholders
      generation_command: "openssl rand -base64 16 | tr -d '=' | head -c 14 && echo '!@#'"

    third_party:
      - service: "Stripe"
        key_env: "STRIPE_TEST_KEY"
        notes: "Use test keys (sk_test_...)"

success_criteria:
  - id: "SC1"
    description: "Success criterion 1"
    completed: false

  - id: "SC2"
    description: "Success criterion 2"
    completed: false

risks:
  - risk: "Potential issue description"
    mitigation: "How to handle it"
    impact: "high | medium | low"

out_of_scope:
  - "Feature not included"
  - "Another excluded item"

future_enhancements:
  - "Idea for later iteration"
  - "Another future feature"

references:
  design_docs: "URL to design documents"
  api_docs: "URL to API documentation"
  related_tickets: "URL to related issues/tickets"
